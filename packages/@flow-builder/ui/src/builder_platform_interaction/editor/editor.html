<template>
    <div if:true={showSpinner} class="slds-spinner_container">
        <lightning-spinner variant="brand" alternative-text={spinnerAlternativeText}></lightning-spinner>
    </div>
    <div role="main" class="slds-grid slds-grid_vertical slds-is-fixed slds-grid_frame">
        <div class="slds-builder-header_container slds-is-relative toolbar-header-container">
            <builder_platform_interaction-header
                role="banner"
                aria-label={labels.ariaLabelHeader}
                flow-name={properties.label}
                flow-version={properties.versionNumber}
                run-in-mode={properties.runInMode}
                help-url={helpUrl}
                trailhead-url={trailheadUrl}
                trailblazer-community-url={trailblazerCommunityUrl}
                back-url={backUrl}
                builder-icon={builderIcon}
                builder-name={builderName}
                guardrails-params={guardrailsParams}
                interview-label={interviewLabel}
                show-interview-label={headerConfig.showInterviewLabel}
                show-debug-status={headerConfig.showDebugStatus}
                debug-interview-status={debugInterviewStatus}
                test-status={testStatus}
                test-label={testLabel}
                show-test-status={headerConfig.showTestStatus}
                overridden-flow={properties.overriddenFlow}
            ></builder_platform_interaction-header>
            <builder_platform_interaction-toolbar
                role="banner"
                aria-label={labels.ariaLabelToolbar}
                ontoggleselectionmode={handleToggleSelectionMode}
                oncopyoncanvas={handleCopy}
                onclick={handleLeftPanelAndToolbarInteraction}
                onduplicate={handleDuplicate}
                oneditflowproperties={handleEditFlowProperties}
                oneditflow={handleEditFlow}
                onrunflow={handleRunFlow}
                ondebugflow={handleDebugFlow}
                onnewdebugflow={handleNewDebugFlow}
                onrestartdebugflow={handleRestartDebugFlow}
                onaddtoflowtest={handleAddToTestFlow}
                onsaveas={handleSaveFlow}
                onsave={handleSaveFlow}
                onundo={handleUndo}
                onredo={handleRedo}
                onviewalltests={handleViewAllTests}
                onedittest={handleEditTest}
                ontoggleflowstatus={handleToggleFlowStatus}
                onclosepropertyeditor={handleClosePropertyEditor}
                ontoolbarfocusout={handleToolbarFocusOut}
                show-copy-paste-button={toolbarConfig.showCopyPasteButton}
                show-edit-flow-properties-button={toolbarConfig.showEditFlowPropertiesButton}
                show-canvas-mode-combobox={showCanvasModeCombobox}
                show-edit-flow-button={toolbarConfig.showEditFlowButton}
                show-run-button={showRunButton}
                show-debug-button={showDebugButton}
                show-add-to-test-button={showAddToTestButton}
                show-run-test-button={showRunTestButton}
                show-restart-run-button={showDebugAgainButton}
                show-flow-status={toolbarConfig.showFlowStatus}
                show-save-button={showSaveButton}
                show-save-as-button={showSaveAsButton}
                show-activate-button={showActivateButton}
                show-undo-redo-button={showUndoRedoButton}
                show-view-all-tests-button={showViewAllTestsButton}
                show-edit-test-button={showEditTestButton}
                flow-errors-and-warnings={flowErrorsAndWarnings}
                save-and-pending-operation-status={saveAndPendingOperationStatus}
                last-modified-date={properties.lastModifiedDate}
                flow-id={flowId}
                flow-version={properties.versionNumber}
                flow-status={flowStatus}
                is-edit-flow-properties-disabled={hasNotBeenSaved}
                is-run-debug-disabled={isRunDebugDisabled}
                is-save-disabled={disableSave}
                is-save-as-disabled={hasNotBeenSaved}
                is-selection-mode={isSelectionMode}
                is-cut-copy-disabled={isCutCopyDisabled}
                is-undo-disabled={isUndoDisabled}
                is-redo-disabled={isRedoDisabled}
                is-view-all-tests-disabled={shouldViewAllTestsButtonBeDisabled}
                is-add-to-test-disabled={shouldAddToTestButtonBeDisabled}
                is-new-debug-supported={useNewDebugExperience}
                is-lightning-flow-builder={properties.isLightningFlowBuilder}
                can-only-save-as-new-definition={properties.canOnlySaveAsNewDefinition}
                has-unsaved-changes={properties.hasUnsavedChanges}
                hide-selection-button={canvasConfig.disableMultiSelectElements}
                ontogglecanvasmode={handleToggleCanvasMode}
                is-auto-layout-canvas={properties.isAutoLayoutCanvas}
                builder-mode={builderMode}
            ></builder_platform_interaction-toolbar>
        </div>
        <div class="slds-col slds-grow slds-grid slds-is-relative">
            <builder_platform_interaction-left-panel
                aria-label={labels.ariaLabelLeftPanel}
                if:true={showLeftPanel}
                onaddnewresource={handleAddResourceElement}
                onaddelement={handleAddCanvasElement}
                onclick={handleLeftPanelAndToolbarInteraction}
                oneditelement={handleEditElement}
                ondeleteelement={handleElementDelete}
                onlocatoriconclicked={handleHighlightOnCanvas}
                elements={toolboxElements}
                palette={palette}
                show-elements-tab={showLeftPanelElementsTab}
                role="complementary"
                invocable-apex-actions={invocableApexActions}
            ></builder_platform_interaction-left-panel>
            <div
                if:true={hasCanvasElements}
                class="test-outer-canvas-container slds-col slds-is-relative"
                oncanvasready={handleCanvasReady}
            >
                <!--
                    W-7866257: Make sure the fixed canvas comes first as both canvas can be in the DOM at the same time
                    for brief moment when toggling (LWC bug?), and the fixed canvas use the offsets of its container
                -->
                <builder_platform_interaction-canvas-container
                    aria-label={labels.ariaLabelCanvasContainer}
                    if:false={properties.isAutoLayoutCanvas}
                    canvas-config={canvasConfig}
                    onaddelement={handleAddCanvasElement}
                    oneditelement={handleEditElement}
                    ondeleteelement={handleElementDelete}
                    ontogglemarqueeon={handleClosePropertyEditor}
                    onclosepropertyeditor={handleClosePropertyEditor}
                    onnodeselected={handleNodeSelected}
                    role="region"
                >
                </builder_platform_interaction-canvas-container>
                <builder_platform_interaction-alc-canvas-container
                    aria-label={labels.ariaLabelCanvasContainer}
                    if:true={properties.isAutoLayoutCanvas}
                    elements-metadata={elementsMetadata}
                    is-selection-mode={isSelectionMode}
                    invocable-apex-actions={invocableApexActions}
                    is-paste-available={isPasteAvailable}
                    disable-delete-elements={canvasConfig.disableDeleteElements}
                    disable-edit-elements={canvasConfig.disableEditElements}
                    active-element-guid={activeElementGuid}
                    onaddelement={handleAddCanvasElement}
                    oncopysingleelement={handleCopySingleElement}
                    ondeleteelement={handleElementDelete}
                    oneditelement={handleEditElement}
                    ontoggleselectionmode={handleToggleSelectionMode}
                    onalcselection={handleSelectionOnFixedCanvas}
                    onpasteoncanvas={handlePasteOnCanvas}
                    onclosepropertyeditor={handleClosePropertyEditor}
                    onnodeselected={handleNodeSelectedOnFixedCanvas}
                    onaddelementfault={handleAddElementFault}
                    ondeleteelementfault={handleDeleteElementFault}
                    oncreategotoconnection={handleGoToCreation}
                    ondeletegotoconnection={handleGoToDeletion}
                    onoutgoinggotostubclick={handleOutgoingGoToStubClick}
                    onopensubflow={handleOpenSubflow}
                    role="region"
                >
                </builder_platform_interaction-alc-canvas-container>
            </div>
            <builder_platform_interaction-right-panel
                aria-label={labels.ariaLabelRightPanel}
                if:true={showRightPanel}
                onaddnewresource={handleAddResourceElement}
                onclosepropertyeditor={handleClosePropertyEditor}
                onaddnode={handleAddNode}
                onupdatenode={handleUpdateNode}
                is-variable-width={isRightPanelVariableWidth}
            >
                <builder_platform_interaction-property-editor-panel
                    if:true={showPropertyEditorRightPanel}
                    element={elementBeingEditedInPanel}
                    params={propertyEditorParams}
                    onreturnfocus={handleReturnFocus}
                >
                </builder_platform_interaction-property-editor-panel>
                <builder_platform_interaction-debug-panel
                    if:true={showDebugPanel}
                    debug-data={debugTraces}
                    from-email-debugging={fromEmailDebugging}
                    onresumedebugflow={handleResumeDebugFlow}
                    if-block-resume={blockDebugResume}
                    builder-mode={builderMode}
                    show-transaction-boundaries={showTransactionBoundaries}
                >
                </builder_platform_interaction-debug-panel>
            </builder_platform_interaction-right-panel>
        </div>
    </div>
</template>
